name: md-docs

dep:
  ops:
    type: git
    url: "https://github.com/hatlonely/ops.git"
    version: master

env:
  default:
    NAME: "rpc-account"
  dev:
    K8S_CONTEXT: "home-k8s"
    NAMESPACE: "dev"
    RPC_ACCOUNT_SERVICE: "k8s.rpc.account.hatlonely.com"
    RPC_ARTICLE_SERVICE: "k8s.rpc.article.hatlonely.com"
    ACCOUNT_EMAIL: "{{ .account.email }}"
    ACCOUNT_PHONE: "{{ .account.phone }}"
    ACCOUNT_NAME: "{{ .account.name }}"
    ACCOUNT_PASSWORD: "{{ .account.password }}"
    ACCOUNT_BIRTHDAY: "{{ .account.birthday }}"
    ACCOUNT_GENDER: "{{ .account.gender }}"
    ACCOUNT_AVATAR: "{{ .account.avatar }}"

task:
  put-user:
    step:
      - |
        curl -XPOST -s "http://${RPC_ACCOUNT_SERVICE}/v1/getAccountByPhoneOrEmail" -d "{
            \"username\": \"${ACCOUNT_EMAIL}\"
          }" | jq -e .id || {
            curl -XPOST -s "http://${RPC_ACCOUNT_SERVICE}/v1/account" -d "{
              \"email\":\"${ACCOUNT_EMAIL}\",
              \"phone\":\"${ACCOUNT_PHONE}\",
              \"name\":\"${ACCOUNT_NAME}\",
              \"password\":\"${ACCOUNT_PASSWORD}\",
              \"birthday\":\"${ACCOUNT_BIRTHDAY}\",
              \"gender\": ${ACCOUNT_GENDER},
              \"avatar\":\"${ACCOUNT_AVATAR}\"
            }"
        }
      - |
        key=$(curl -XPOST -s "http://${RPC_ACCOUNT_SERVICE}/v1/getAccountByPhoneOrEmail" -d "{\"username\": \"${ACCOUNT_EMAIL}\"}" | jq -e -r .id)
        curl -XPOST -H "Origin:localhost" -s "http://${RPC_ARTICLE_SERVICE}/v1/addOrUpdateAuthor" -d "{
          \"key\": \"${key}\",
          \"name\": \"${ACCOUNT_NAME}\"
        }" && echo
  put-article:
    step:
      - |
        author_id=$(curl -XPOST -H "Origin:localhost" -s "http://${RPC_ARTICLE_SERVICE}/v1/addOrUpdateAuthor" -d "{
          \"key\": \"${key}\",
          \"name\": \"${ACCOUNT_NAME}\"
        }" | jq -e -r .id)
        python3 ops/tool/md2json.py -a ${author_id} -d "linux,golang,flutter" > "${TMP}/result.json"
      - cat "${TMP}/result.json" | while read -r line; do curl -H "Origin:localhost" -X POST --data-binary "$line" http://${RPC_ARTICLE_SERVICE}/v1/article; echo; done
